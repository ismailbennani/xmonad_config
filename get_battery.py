#!/usr/bin/env python3

battery_xpm =\
[
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"..           .. \",",
        "\"..           ...\",",
        "\"..           ...\",",
        "\"..           ...\",",
        "\"..           .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"...          .. \",",
        "\"...          ...\",",
        "\"...          ...\",",
        "\"...          ...\",",
        "\"...          .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"....         .. \",",
        "\"....         ...\",",
        "\"....         ...\",",
        "\"....         ...\",",
        "\"....         .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\".....        .. \",",
        "\".....        ...\",",
        "\".....        ...\",",
        "\".....        ...\",",
        "\".....        .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"......       .. \",",
        "\"......       ...\",",
        "\"......       ...\",",
        "\"......       ...\",",
        "\"......       .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\".......      .. \",",
        "\".......      ...\",",
        "\".......      ...\",",
        "\".......      ...\",",
        "\".......      .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"........     .. \",",
        "\"........     ...\",",
        "\"........     ...\",",
        "\"........     ...\",",
        "\"........     .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\".........    .. \",",
        "\".........    ...\",",
        "\".........    ...\",",
        "\".........    ...\",",
        "\".........    .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"..........   .. \",",
        "\"..........   ...\",",
        "\"..........   ...\",",
        "\"..........   ...\",",
        "\"..........   .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"...........  .. \",",
        "\"...........  ...\",",
        "\"...........  ...\",",
        "\"...........  ...\",",
        "\"...........  .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"............ .. \",",
        "\"............ ...\",",
        "\"............ ...\",",
        "\"............ ...\",",
        "\"............ .. \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
        "\" .............  \",",
        "\"............... \",",
        "\"............... \",",
        "\"................\",",
        "\"................\",",
        "\"................\",",
        "\"............... \",",
        "\"............... \",",
        "\" .............  \",",
        "\"                \",",
        "\"                \",",
        "\"                \",",
    ],
]

plugged_xpm =\
[
    "\"       .  .     \",",
    "\"       .  .     \",",
    "\"       .  .     \",",
    "\"     ........   \",",
    "\"                \",",
    "\"     ........   \",",
    "\"     ........   \",",
    "\"      ......    \",",
    "\"       ....     \",",
    "\"        ..      \",",
    "\"  ..    ..      \",",
    "\"  ..    ..      \",",
    "\"  ..    ..      \",",
    "\"  ...  ...      \",",
    "\"   ......       \",",
    "\"    ....        \",",
]

from utils import writexpm
from os.path import expanduser
import sys, subprocess

plugged = subprocess.getoutput("cat /sys/class/power_supply/AC/online") == "1"
print("Plugged:", plugged, file=sys.stderr)

cap = int(subprocess.getoutput("cat /sys/class/power_supply/BAT0/capacity"))

if plugged and cap == 100:
    url = expanduser("~/.xmonad/xpm/plugged_%s.xpm")
    print("<icon=%s/>" % writexpm(url, plugged_xpm, "white"))
    exit(0)

lvl = cap * len(battery_xpm) // 100
url = expanduser("~/.xmonad/xpm/battery_%d_%%s.xpm") % lvl

if not plugged:
    tte = subprocess.getoutput("upower -i /org/freedesktop/UPower/devices/battery_BAT0 | grep 'time to empty:'").strip().split("  ")[-1].strip()
    print("Time to empty:", tte, file=sys.stderr)
    suffix = tte
else:
    suffix = "<fc=green>Charging</fc>"

out = "<icon=%%s/> %d%%%% %s" % (cap, suffix)
print(out % writexpm(url, battery_xpm[lvl], "white"))
