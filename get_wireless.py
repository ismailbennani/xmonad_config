#!/usr/bin/env python3

wireless_xpm =\
[
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  .          .  \",",
        "\"   .        .   \",",
        "\"    .      .    \",",
        "\"     .    .     \",",
        "\"      .  .      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  .          .  \",",
        "\"   .        .   \",",
        "\"    .      .    \",",
        "\"     .    .     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  .          .  \",",
        "\"   .        .   \",",
        "\"    .      .    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  .          .  \",",
        "\"   .        .   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  .          .  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .            . \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\".              .\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\".              .\",",
        "\"................\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .            . \",",
        "\"................\",",
        "\"................\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ..        ..  \",",
        "\" .............. \",",
        "\"................\",",
        "\"................\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ..    ..    \",",
        "\"  ............  \",",
        "\" .............. \",",
        "\"................\",",
        "\"................\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
    [
        "\"      ....      \",",
        "\"    ........    \",",
        "\"  ............  \",",
        "\" .............. \",",
        "\"................\",",
        "\"................\",",
        "\" .............. \",",
        "\"  ............  \",",
        "\"   ..........   \",",
        "\"    ........    \",",
        "\"     ......     \",",
        "\"      ....      \",",
        "\"       ..       \",",
        "\"       ..       \",",
        "\"                \",",
        "\"                \",",
    ],
]

hotspot_xpm = \
[
    "\"                \",",
    "\"   .       .    \",",
    "\"  .         .   \",",
    "\" .  . ... .  .  \",",
    "\" . . .   . . .  \",",
    "\" . . . . . . .  \",",
    "\" . .  ...  . .  \",",
    "\" .    . .    .  \",",
    "\"  .  .. ..  .   \",",
    "\"     .   .      \",",
    "\"    ..   ..     \",",
    "\"    .     .     \",",
    "\"   ..     ..    \",",
    "\"   .       .    \",",
    "\"   .........    \",",
    "\"                \","
]

from utils import writexpm
from os.path import expanduser

def writewirelessxpm(lvl, col):
    url = expanduser("~/.xmonad/xpm/wireless_%d_%%s.xpm") % lvl

    return writexpm(url, wireless_xpm[lvl], col)

def writehotspotxpm(col):
    url = expanduser("~/.xmonad/xpm/hotspot_%s.xpm")

    return writexpm(url, hotspot_xpm, col)

def get_wireless_interface():
    interfaces = subprocess.getoutput("ls /sys/class/net").split()
    interfaces = [i for i in interfaces if i[:1] == "w"]
    print("Wireless interfaces:", interfaces, file=sys.stderr)

    chosen_i = None
    connected_to = None
    enabled = None
    ishotspot = None

    for i in interfaces:
        isactive = subprocess.getoutput("cat /sys/class/net/%s/operstate" % i) == "up"
        isenabled = subprocess.getoutput("cat /sys/class/net/%s/link_mode" % i) == "1"
        if isactive:
            chosen_i = i
            enabled = True
            ishotspot = subprocess.getoutput("iw dev %s info | grep type" % i).strip()[5:] == "AP"
            connected_to = subprocess.getoutput("iw dev %s info | grep ssid" % i).strip()[5:]
        elif isenabled and chosen_i is None:
            chosen_i = i
            enabled = i

    return chosen_i, connected_to, enabled, ishotspot

import sys, subprocess

interface, name, enabled, ishotspot = get_wireless_interface()
print("Chosen interface:", interface, file=sys.stderr)
print("Enabled:", enabled, file=sys.stderr)
print("Hotspot:", ishotspot, file=sys.stderr)


if not enabled:
    name = ""
    col  = "red"
    icon = writewirelessxpm(0, col)
else:
    print("SSID: %s" % name, file=sys.stderr)

    col = "white"
    if name is None:
        name = ""
        icon = writewirelessxpm(0, col)
    else:
        if ishotspot:
            icon = writehotspotxpm(col)
        else:
            wifi_strength = int(subprocess.getoutput("awk 'NR==3 {print $3}''' /proc/net/wireless")[:-1])
            print("Strength: %d%%" % wifi_strength, file=sys.stderr)

            lvl = wifi_strength // 10 + 1
            icon = writewirelessxpm(lvl, col)
        name = " " + name

out = "<icon=%s/>%s"
toggle = "<action=`~/.xmonad/toggle_wireless.sh` button=1>%s</action>"
nmtui = "<action=`terminator -e nmtui` button=3>%s</action>"

print(nmtui % toggle % out % (icon, name))
